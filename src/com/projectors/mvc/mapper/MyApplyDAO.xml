<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.projectors.mvc.dao.IMyApplyDAO">

	<!-- 샘플 <select resultType="com.projectors.mvc.RecruitDTO" id="countRecruitMember"> 
		SELECT SUM(COUNTALL) AS COUNTALL , SUM(COUNTPOS) AS COUNTPOS , RECRUITNO 
		FROM RECRUITPOSITIONVIEW WHERE RECRUITNO LIKE '%' || #{recruitNo } GROUP 
		BY RECRUITNO </select> -->
	
	<select id="checkPresentApply" resultType="java.lang.Integer">
		SELECT  COUNT(*) AS COUNT
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14
	</select>
	
	<select id="checkFirstCk" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM FIRST_CK FS
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14
	</select> 
	
	<select id="checkFinal" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM FINAL FN
		LEFT JOIN FIRST_CK FS ON FN.FIRST_CK_NO = FS.FIRST_CK_NO
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14	
	</select> 
	
	<select id="checkProject" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM PROJECT
		WHERE RECRUIT_NO=#{recruitNo}
	</select>
	
	
	<!--  ▲  보여줄 이력이 있는지 판단하기 위함 -->
	
	
	<!-- ▷ 지원서가 취소 가능한 상태인지 조회  -->
	<select id="checkDeleteApply" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM APPLY AP
		WHERE AP.APPLY_NO = #{applyNo} AND AP.APPLY_NO NOT IN (SELECT APPLY_NO FROM FIRST_CK)
	</select>
	
	<!-- ▷ 지원서 취소하는 쿼리문  -->
	<delete id="deleteApply">
		DELETE
		FROM APPLY
		WHERE APPLY_NO=#{applyNo}
	</delete>	
	
	<!--  ▼  각 상태에 따른 지원 이력 정보 가지고 오기 위함 -->
	
	<select id="getPresentApply" resultType="com.projectors.mvc.dto.MyApplyDTO">
		SELECT AP.APPLY_NO AS APPLYNO, REP.RECRUIT_POS_NO AS RECRUITPOSNO, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS TITLE
      	 ,NVL(US.NICKNAME,'탈퇴회원') AS NICKNAME , AP.APPLY_DATE AS APPLYDATE, AP.CK_DATE AS CKDATE
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		LEFT JOIN POSITION POS ON REP.POS_NO = POS.POS_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14
	</select>
	
	<select id="getFirstCk" resultType="com.projectors.mvc.dto.MyApplyDTO">
		SELECT AP.APPLY_NO AS APPLYNO, REP.RECRUIT_POS_NO AS RECRUITPOSNO, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS TITLE
       	 ,NVL(US.NICKNAME,'탈퇴회원') AS NICKNAME , FS.PASS_DATE AS PASSDATE, FS.FIRST_CK_NO AS FIRSTCKNO
		FROM FIRST_CK FS
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		LEFT JOIN POSITION POS ON REP.POS_NO = POS.POS_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14
	</select>
	
	<select id="getFinal" resultType="com.projectors.mvc.dto.MyApplyDTO">
		SELECT AP.APPLY_NO AS APPLYNO, REP.RECRUIT_POS_NO AS RECRUITPOSNO, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS TITLE
        ,NVL(US.NICKNAME,'탈퇴회원') AS NICKNAME , FN.FINAL_CK_DATE AS FINALCKDATE
		FROM FINAL FN
		LEFT JOIN FIRST_CK FS ON FN.FIRST_CK_NO = FS.FIRST_CK_NO
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		LEFT JOIN POSITION POS ON REP.POS_NO = POS.POS_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		WHERE AP.PIN_NO=#{pinNo} AND REC.CREATED_DATE > SYSDATE-14
	</select>


	<!-- 공고의 전체 모집 인원 -->
	<select id="memberCount" resultType="java.lang.Integer">
		SELECT COUNT(RECRUIT_POS_NO) AS COUNT
		FROM RECRUIT_POS REP
		WHERE REP.RECRUIT_NO = #{recruitNo}
	</select>
	
	<!-- 공고의 1차 합류 인원-->
	<select id="firstCkCount" resultType="java.lang.Integer">
		SELECT COUNT(FIRST_CK_NO) AS COUNT
		FROM FIRST_CK FS
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		WHERE REP.RECRUIT_NO = #{recruitNo}
	</select>
	
	<!-- 공고의 최종 합류 인원  -->
	<select id="finalCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM FINAL FN
		LEFT JOIN FIRST_CK FS ON FN.FIRST_CK_NO = FS.FIRST_CK_NO
		LEFT JOIN APPLY AP ON FS.APPLY_NO = AP.APPLY_NO
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE REC.RECRUIT_NO=#{recruitNo}
	</select>
	
	
	<!-- 최종 합류 버튼 클릭 시 수행 될 메소드  -->
	<insert id="addFinal">
		INSERT INTO FINAL
		VALUES
		( 'FN'||TO_CHAR(FINALNOSEQ.NEXTVAL)
		, #{firstCkNo} 
		, SYSDATE)
	</insert>
	
	<!-- 최종 합류 인원과 모집 인원이 동일할 때 프로젝트 add 하는 메소드  -->
	<insert id="addProject">
		INSERT INTO PROJECT
		VALUES
		( 'PS'||TO_CHAR(PRJSTOPNOSEQ.NEXTVAL)
		, #{recruitNo}
		, SYSDATE)
	</insert>
	
	
	<select id="checkPastApply" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		WHERE AP.PIN_NO = #{pinNo} AND SYSDATE-14 >=  REC.CREATED_DATE 
	</select>
	
	<select id="getPastApply" resultType="com.projectors.mvc.dto.MyApplyDTO">
		SELECT AP.APPLY_NO AS APPLYNO, REP.RECRUIT_POS_NO AS RECRUITPOSNO, POS.POS_NAME AS POSNAME, REC.RECRUIT_NO AS RECRUITNO, REC.TITLE AS TITLE
        ,NVL(US.NICKNAME,'탈퇴회원') AS NICKNAME , AP.APPLY_DATE AS APPLYDATE, FS.APPLY_NO AS FSAPPLYNO, AP.CK_DATE AS CKDATE, PRJ.PRJ_NO AS PRJNO
		FROM APPLY AP
		LEFT JOIN RECRUIT_POS REP ON AP.RECRUIT_POS_NO = REP.RECRUIT_POS_NO
		LEFT JOIN RECRUIT REC ON REP.RECRUIT_NO = REC.RECRUIT_NO
		LEFT JOIN POSITION POS ON REP.POS_NO = POS.POS_NO
		LEFT JOIN USERS US ON AP.PIN_NO = US.PIN_NO
		FULL OUTER JOIN FIRST_CK FS ON AP.APPLY_NO = FS.APPLY_NO
		FULL OUTER JOIN PROJECT PRJ ON REC.RECRUIT_NO = PRJ.RECRUIT_NO
		WHERE AP.PIN_NO = #{pinNo} AND  SYSDATE-14 >= REC.CREATED_DATE
	</select>

	
	
</mapper>